@{
    ViewData["Title"] = "Giỏ hàng";
}

<div class="container mt-4">
    <h2 class="text-center">Thanh toán</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["SuccessMessage"]
            <a href="/Home/Index" class="btn btn-primary btn-sm">Về trang chủ</a>
        </div>
    }

    <div class="row">
        <!-- Thông tin khách hàng -->
        <div class="col-md-6">
            <h4>Thông tin giao hàng</h4>
            <form method="post" action="/Shopping/Shopping" id="checkout-form">
                <div class="mb-3">
                    <label for="fullName" class="form-label">Họ và tên</label>
                    <input type="text" class="form-control" id="fullName" name="fullName" required>
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Số điện thoại</label>
                    <input type="tel" class="form-control" id="phone" name="phone" required>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Địa chỉ giao hàng</label>
                    <textarea class="form-control" id="address" name="address" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="paymentMethod" class="form-label">Phương thức thanh toán</label>
                    <select class="form-control" id="paymentMethod" name="paymentMethod" required>
                        <option value="cod">Thanh toán khi nhận hàng (COD)</option>
                        <option value="bank">Chuyển khoản ngân hàng</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Xác nhận thanh toán</button>
            </form>
        </div>

        <!-- Danh sách sản phẩm trong giỏ hàng -->
        <div class="col-md-6">
            <h4>Đơn hàng của bạn</h4>
            <ul class="list-group" id="cart-items">
                <!-- Sản phẩm sẽ được hiển thị tại đây -->
            </ul>
            <div class="list-group-item d-flex justify-content-between">
                <strong>Tổng tiền</strong>
                <strong id="total-price">0 đ</strong>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let cart = JSON.parse(localStorage.getItem("tempShopping")) || {};
        let cartList = document.getElementById("cart-items");
        let totalPrice = 0;

        function updateCartUI() {
            cartList.innerHTML = "";
            totalPrice = 0;

            for (let key in cart) {
                let item = cart[key];
                let itemTotal = item.itemPrice * item.itemAmount;
                totalPrice += itemTotal;

                let listItem = document.createElement("li");
                listItem.className = "list-group-item d-flex justify-content-between align-items-center";
                listItem.innerHTML = `
                        <div>
                            <strong>${item.itemName}</strong>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-secondary btn-sm me-2" onclick="changeAmount('${key}', -1)">-</button>
                                <span id="amount-${key}" class="me-2">${item.itemAmount}</span>
                                <button class="btn btn-secondary btn-sm me-2" onclick="changeAmount('${key}', 1)">+</button>
                            </div>
                        </div>
                        <div>
                            <span id="price-${key}">${itemTotal.toLocaleString()} đ</span>
                            <button class="btn btn-danger btn-sm ms-2" onclick="removeItem('${key}')">X</button>
                        </div>
                    `;

                cartList.appendChild(listItem);
            }

            document.getElementById("total-price").innerText = totalPrice.toLocaleString() + " đ";
            localStorage.setItem("tempShopping", JSON.stringify(cart)); // Lưu lại giỏ hàng
        }

        updateCartUI(); // Cập nhật giao diện khi load trang

        // Hàm thay đổi số lượng
        window.changeAmount = function (itemId, change) {
            if (cart[itemId]) {
                cart[itemId].itemAmount += change;
                if (cart[itemId].itemAmount < 1) cart[itemId].itemAmount = 1; // Không cho số lượng nhỏ hơn 1
                updateCartUI();
            }
        };

        // Hàm xóa sản phẩm khỏi giỏ hàng
        window.removeItem = function (itemId) {
            delete cart[itemId];
            updateCartUI();
        };

        // Xử lý sự kiện thanh toán
        document.getElementById("checkout-form").addEventListener("submit", function (event) {
            event.preventDefault();
            let orderData = {
                fullName: document.getElementById("fullName").value,
                phone: document.getElementById("phone").value,
                address: document.getElementById("address").value,
                paymentMethod: document.getElementById("paymentMethod").value,
                cart: cart
            };

            fetch("/Shopping/Shopping", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Đặt hàng thành công!");
                        localStorage.removeItem("tempShopping"); // Xóa giỏ hàng sau khi đặt hàng
                        window.location.href = "/Home/Index";
                    } else {
                        alert("Có lỗi xảy ra, vui lòng thử lại!");
                    }
                });
        });
    });
</script>
