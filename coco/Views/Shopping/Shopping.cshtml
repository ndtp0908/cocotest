@{
    ViewData["Title"] = "Giỏ hàng";
}
<div class="container mt-4">
    <h2 class="text-center" style="font-size:50px; color:brown"><strong>GIỎ HÀNG</strong></h2>

    <div id="error-message" class="alert alert-danger d-none"></div>
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["SuccessMessage"]
            <a href="/Home/Index" class="btn btn-primary btn-sm">Về trang chủ</a>
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <h4>Thông tin giao hàng</h4>
            <form method="post" action="/Shopping/Shopping" id="checkout-form">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fullName" class="form-label"><strong>Họ và Tên</strong></label>
                        <input type="text" class="form-control" id="fullName" name="fullName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="phone" class="form-label"><strong>Số điện thoại</strong></label>
                        <input type="text" class="form-control" id="phone" name="phone" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="address" class="form-label"><strong>Địa chỉ giao hàng</strong></label>
                        <input type="text" class="form-control" id="address" name="address" required></input>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="voucher" class="form-label"><strong>Mã giảm giá</strong></label>
                        <input type="text" class="form-control" id="voucher">
                    </div>                    
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="paymentMethod" class="form-label"><strong>Phương thức thanh toán</strong></label>
                        <select class="form-control" id="paymentMethod" name="paymentMethod" required>
                            <option value="cod">Thanh toán khi nhận hàng (COD)</option>
                            <option value="bank">Chuyển khoản ngân hàng</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col text-center" id="qr-container" style="display: none;">
                        <h5>Mã QR thanh toán</h5>
                        <img id="qr-code" src="" alt="QR Code" style="max-width: 200px; margin: auto;">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-3">Xác nhận thanh toán</button>
            </form>
        </div>


        <div class="col-md-6">
            <h4>Đơn hàng của bạn</h4>
            <ul class="list-group" id="cart-items"></ul>
            <div class="list-group-item d-flex justify-content-between">
                <strong>Tổng tiền</strong>
                <strong id="total-price">0 đ</strong>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let cart = JSON.parse(localStorage.getItem("tempShopping")) || {};
        let cartList = document.getElementById("cart-items");
        let totalPrice = 0;

        let user = JSON.parse(localStorage.getItem("user"));
        if (user) {
            document.getElementById("fullName").value = user.name || "";
            document.getElementById("phone").value = user.phone || "";
            document.getElementById("address").value = user.address || "";
        }

        function updateCartUI() {
            cartList.innerHTML = "";
            totalPrice = 0;

            for (let key in cart) {
                let item = cart[key];
                let itemTotal = item.itemPrice * item.itemAmount;
                totalPrice += itemTotal;

                let listItem = document.createElement("li");
                listItem.className = "list-group-item d-flex justify-content-between align-items-center";
                listItem.innerHTML = `
                        <div>
                            <strong>${item.itemName}</strong>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-secondary btn-sm me-2" onclick="changeAmount('${key}', -1)">-</button>
                                <span id="amount-${key}" class="me-2">${item.itemAmount}</span>
                                <button class="btn btn-secondary btn-sm me-2" onclick="changeAmount('${key}', 1)">+</button>
                            </div>
                        </div>
                        <div>
                            <span id="price-${key}">${itemTotal.toLocaleString()} đ</span>
                            <button class="btn btn-danger btn-sm ms-2" onclick="removeItem('${key}')">X</button>
                        </div>
                    `;

                cartList.appendChild(listItem);
            }

            document.getElementById("total-price").innerText = totalPrice.toLocaleString() + " đ";
            localStorage.setItem("tempShopping", JSON.stringify(cart));
        }

        updateCartUI();

        window.changeAmount = function (itemId, change) {
            if (cart[itemId]) {
                cart[itemId].itemAmount += change;
                if (cart[itemId].itemAmount < 1) cart[itemId].itemAmount = 1;
                updateCartUI();
            }
        };

        window.removeItem = function (itemId) {
            delete cart[itemId];
            updateCartUI();
        };

        document.getElementById("checkout-form").addEventListener("submit", function (event) {
            event.preventDefault();

            let cart = JSON.parse(localStorage.getItem("tempShopping")) || {};
            let user = JSON.parse(localStorage.getItem("user")) || {};

            let cartItems = Object.keys(cart).map(key => ({
                itemId: cart[key].itemId,
                itemAmount: cart[key].itemAmount,
                itemPrice: cart[key].itemPrice
            }));

            let totalAmount = cartItems.reduce((acc, item) => acc + (item.itemAmount * item.itemPrice), 0);

            let orderData = {
                userId: user.userId || null,
                fullName: document.getElementById("fullName").value,
                phone: document.getElementById("phone").value,
                address: document.getElementById("address").value,
                paymentMethod: document.getElementById("paymentMethod").value,
                discount: 0,
                total: totalAmount,
                cart: cartItems
            };

            fetch("/Shopping/Shopping", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(orderData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        localStorage.removeItem("tempShopping");
                        window.location.href = "/Shopping/Success";
                    } else {
                        let errorMessage = document.getElementById("error-message");
                        errorMessage.textContent = data.message;
                        errorMessage.classList.remove("d-none");
                    }
                })
                .catch(error => {
                    console.error("🔴 Fetch Error:", error);
                    let errorMessage = document.getElementById("error-message");
                    errorMessage.textContent = "Có lỗi xảy ra khi gửi yêu cầu. Vui lòng thử lại!";
                    errorMessage.classList.remove("d-none");
                });
        });
    });
    document.getElementById("paymentMethod").addEventListener("change", function () {
        let qrContainer = document.getElementById("qr-container");
        let qrImage = document.getElementById("qr-code");

        if (this.value === "bank") {
            qrImage.src = "/image/qr.jpg";
            qrContainer.style.display = "block";
        } else {
            qrContainer.style.display = "none";
        }
    });
</script>
